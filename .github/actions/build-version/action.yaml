name: Generate Build Version
description: Generate Build Version

inputs:
  ref:
    description: 'The branch, tag or SHA to checkout'
    required: true
outputs:
  build_version:
    description: "Build version"
    value: ${{ steps.prepare-build-version.outputs.version }}

runs:
  using: composite
  steps:
    - name: Prepare build version
      id: prepare-build-version
      shell: bash
      run: |
        ref_name=${{ github.ref_name }}"
        ref=${{ github.ref }}"
        
        base_version=$(<VERSION)
        ref_sanitized=${ref_name//\//-}
        tag="${base_version}-${ref_sanitized}"

        # If not a tag build, append the short SHA
        if [[ "$ref" != refs/tags/* ]]; then
          tag+="-$(git rev-parse --short HEAD)"
        fi
        echo "version=$tag"
        echo "version=$tag" >> "$GITHUB_OUTPUT"
